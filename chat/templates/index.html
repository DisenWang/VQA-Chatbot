{% extends 'base.html' %}
{% load static %}
{% block sidebar %}

{% endblock %}
{% block messages %}
  <div class="messages">

<!--     <div class="row chat_row_human">
      <div class="col s9 l7 right">
        <div class="card-panel light-blue darken-4 right">
          <span class="white-text">Hey, how are you doing today ?
          </span>
        </div>
      </div>
    </div>
 -->

    <div class="row chat_bot_row">
      <img src="{% static 'images/bot.jpg'%}" width="40px" height="40px" class="circle" align="left">
      <div class="col s9 l7 left chat_bot">
        <div class="card-panel black-text grey lighten-3">
          <span class="black-text">{{ bot_intro_message }}
          </span>
        </div>
      </div>
  </div>

  </div>
{% endblock %}


{% block message_typing %}
<nav class="message_typing z-depth-3">
  <div class="nav-wrapper">
    <!-- <form> -->
      <div class="row">
        <div class="col s1 file-field">
            <input type="file">
            <i class="material-icons">add_a_photo</i>
        </div>
        <div class="col s11 input-field">
          <input id="question" type="text" placeholder="Start typing question here ..." autocomplete="off">
          <!-- <label for="question">Start typing question here ...</label> -->
          <i class="material-icons">close</i>
        </div>
      </div>
    <!-- </form> -->
  </div>
</nav>

<script type="text/javascript">

  var image = ""; 
  $("#question").keypress(function (e) {
    var key = e.which;
    var question = $("#question").val();
    if(key == 13 && question != '')  // the enter key code
    {
      console.log("Question submitted");
      $("#question").val('');
      var userChatDiv = $('<div class="row chat_row_human"></div>');
      var userColDiv = $('<div class="col s9 l7 right"></div>');
      var userCardPanelDiv = $('<div class="card-panel light-blue darken-4 right"></div>');

      $(userCardPanelDiv).prepend('<span class="white-text">' + question + '</span>');
      $(userColDiv).prepend(userCardPanelDiv);
      $(userChatDiv).prepend(userColDiv);
      $(".messages").append(userChatDiv);
      $("html, body").animate({ scrollTop: $(document).height()-$(window).height() }, 100);

      if (image == ""){ // Handles the condition when no image is uploaded yet 
        var botChatDiv = $('<div class="row chat_bot_row"></div>');
        var botImage = $('<img src="{% static 'images/bot.jpg'%}" width="40px" height="40px" class="circle" align="left">');
        var botColDiv = $('<div class="col s9 l7 left chat_bot"></div>');
        var botCardPanelDiv = $('<div class="card-panel black-text grey lighten-3"></div>');

        $(botCardPanelDiv).prepend('<span class="black-text">' + "Ummm...I think you forgot to upload an image. Please upload an image to continue. :-)" + '</span>');
        $(botColDiv).prepend(botCardPanelDiv);
        $(botChatDiv).prepend(botColDiv);
        $(botChatDiv).prepend(botImage);
        $(".messages").append(botChatDiv);
        $("html, body").animate({ scrollTop: $(document).height()-$(window).height() }, 100);

      }
      else{
        console.log("Image is present and the url is " + image);

        var formData = new FormData();
        formData.append('img_path', image);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        formData.append('socketid', '{{ socketid }}');
        formData.append('question', question);
        $.ajax({
          type    : 'POST', // define the type of HTTP verb we want to use (POST for our form)
          url     : '{% url 'home' %}', // the url where we want to POST
          data    : formData,
          processData: false,  // tell jQuery not to process the data
          contentType: false, 
        })
        .done(function(response) {
          console.log("Question submitted successfully.");
        });

      }
    }
  });

  // Below function is to show the preview of file being uploaded
  function readURL(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();

        var formData = new FormData();
        formData.append('file', input.files[0]);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        formData.append('socketid', '{{ socketid }}');
        $.ajax({
          type    : 'POST', // define the type of HTTP verb we want to use (POST for our form)
          url     : '{% url 'upload' %}', // the url where we want to POST
          data    : formData,
          processData: false,  // tell jQuery not to process the data
          contentType: false, 
        })
        .done(function(response) {
          console.log(response['file_path']);
          image = response['file_path'];
        });

        var userChatDiv = $('<div class="row chat_row_human gcam_image"></div>');
        var userColDiv = $('<div class="col s9 l7 right"></div>');
        var userCardPanelDiv = $('<div class="card-panel light-blue darken-4 right"></div>');
        var imageElement = $('<img src="" class="materialboxed responsive-img" width="300px">');
        $(userCardPanelDiv).prepend(imageElement);
        $(userColDiv).prepend(userCardPanelDiv);
        $(userChatDiv).prepend(userColDiv);
        $(".messages").append(userChatDiv);

        reader.onload = function (e) {
            $(imageElement).attr('src', e.target.result);
        }
        reader.readAsDataURL(input.files[0]);
        $('.materialboxed').materialbox();
        $("html, body").animate({ scrollTop: $(document).height()-$(window).height() }, 100);
    }
}

$("input:file").change(function(){
    readURL(this);
});


</script>

<script type="text/javascript">

  var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
  var socket = new WebSocket(ws_scheme + '://' + window.location.host + "/chat" + window.location.pathname);
  socket.onopen = function() {
      console.log("User connected to the socket with socketid "+ "{{socketid}}");
      socket.send("{{ socketid }}");
  }
  socket.onmessage = function(response) {
    console.log("Getting response from the worker.....");
    console.log(JSON.parse(response.data));
    response = JSON.parse(response.data);
    if ("info" in response){
      console.log("Info is there as the key");
    }
    if ("terminal" in response) {
      console.log(response['terminal']);
    }
    if("result" in response){
      result = JSON.parse(response['result']);
      console.log(result);

      // Show the answer predcited by Bot
      var botChatDiv = $('<div class="row chat_bot_row"></div>');
      var botImage = $('<img src="{% static 'images/bot.jpg'%}" width="40px" height="40px" class="circle" align="left">');
      var botColDiv = $('<div class="col s9 l7 left chat_bot"></div>');
      var botCardPanelDiv = $('<div class="card-panel black-text grey lighten-3"></div>');

      $(botCardPanelDiv).prepend('<span class="black-text">' + result['answer'] + '</span>');
      $(botColDiv).prepend(botCardPanelDiv);
      $(botChatDiv).prepend(botColDiv);
      $(botChatDiv).prepend(botImage);
      $(".messages").append(botChatDiv);
      $("html, body").animate({ scrollTop: $(document).height()-$(window).height() }, 100);

      // Show the text before showing the attention map image
      setTimeout(function(){
        var botChatDiv = $('<div class="row chat_bot_row"></div>');
        var botImage = $('<img src="{% static 'images/bot.jpg'%}" width="40px" height="40px" class="circle" align="left">');
        var botColDiv = $('<div class="col s9 l7 left chat_bot"></div>');
        var botCardPanelDiv = $('<div class="card-panel black-text grey lighten-3"></div>');

        $(botCardPanelDiv).prepend('<span class="black-text">' + "Do you want to see where I looked at the image while predicting this answer? See the below image." + '</span>');
        $(botColDiv).prepend(botCardPanelDiv);
        $(botChatDiv).prepend(botColDiv);
        $(botChatDiv).prepend(botImage);
        $(".messages").append(botChatDiv);
        $("html, body").animate({ scrollTop: $(document).height()-$(window).height() }, 100);
      }, 1000);

      // Show the attention Image 
      setTimeout(function(){
        var botChatDiv = $('<div class="row chat_bot_row gcam_image"></div>');
        var botImage = $('<img src="{% static 'images/bot.jpg'%}" width="40px" height="40px" class="circle" align="left">');
        var botColDiv = $('<div class="col s9 l7 left chat_bot"></div>');
        var botCardPanelDiv = $('<div class="card-panel black-text grey lighten-3"></div>');
        var imageElement = $('<img src="' +  result['svqa_gcam'] + '" class="materialboxed responsive-img" width="300px">');

        $(botCardPanelDiv).prepend(imageElement);
        $(botColDiv).prepend(botCardPanelDiv);
        $(botChatDiv).prepend(botColDiv);
        $(botChatDiv).prepend(botImage);
        $(".messages").append(botChatDiv);
        $('.materialboxed').materialbox();
        $("html, body").animate({ scrollTop: $(document).height() }, "slow");
      }, 2000);

    }
  }

</script>
{% endblock %}
